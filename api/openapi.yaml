openapi: 3.0.3
info:
  title: Notification Service API
  description: |
    Event-driven notification system: create and manage notifications (single or batch),
    cancel pending items, and query status. Health and metrics endpoints for observability.
  version: 1.0.0
  contact:
    name: Notification Service

servers:
  - url: http://localhost:8080
    description: Local development

tags:
  - name: Notifications
    description: Single and batch notification operations
  - name: Batches
    description: Batch retrieval and cancel
  - name: System
    description: Health and metrics

paths:
  /notifications:
    post:
      tags: [Notifications]
      summary: Create single notification
      operationId: createNotification
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NotificationItem'
      responses:
        '201':
          description: Notification created and queued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Notification'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Duplicate request (idempotency key already used)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    get:
      tags: [Notifications]
      summary: List notifications
      operationId: listNotifications
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, queued, sent, failed, cancelled]
        - name: channel
          in: query
          schema:
            type: string
            enum: [sms, email, push]
        - name: batch_id
          in: query
          schema:
            type: string
        - name: from
          in: query
          description: Filter by created_at >= (RFC3339)
          schema:
            type: string
            format: date-time
        - name: to
          in: query
          description: Filter by created_at <= (RFC3339)
          schema:
            type: string
            format: date-time
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
            minimum: 1
            maximum: 1000
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
            minimum: 0
      responses:
        '200':
          description: Paginated list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotificationListResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /notifications/{id}:
    get:
      tags: [Notifications]
      summary: Get notification by ID
      operationId: getNotification
      parameters:
        - $ref: '#/components/parameters/NotificationId'
      responses:
        '200':
          description: Notification details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Notification'
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /notifications/{id}/cancel:
    post:
      tags: [Notifications]
      summary: Cancel notification
      operationId: cancelNotification
      parameters:
        - $ref: '#/components/parameters/NotificationId'
      responses:
        '204':
          description: Cancelled
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Already in terminal state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /notifications/batches:
    post:
      tags: [Notifications]
      summary: Create batch of notifications
      description: Create 1â€“1000 notifications in one request. Optional idempotency key from first item.
      operationId: createNotificationBatch
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: array
              minItems: 1
              maxItems: 1000
              items:
                $ref: '#/components/schemas/NotificationItem'
      responses:
        '201':
          description: Batch created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchCreateResponse'
        '400':
          description: Validation or batch size error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Duplicate request (idempotency key)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /batches/{id}/notifications:
    get:
      tags: [Batches]
      summary: Get batch and its notifications
      operationId: getBatchWithNotifications
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Batch and notifications
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchWithNotificationsResponse'
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /batches/{id}/cancel:
    post:
      tags: [Batches]
      summary: Cancel all pending notifications in batch
      operationId: cancelBatch
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Number of cancelled notifications
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CancelBatchResponse'
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /health:
    get:
      tags: [System]
      summary: Health check
      description: Checks DB and Redis. Returns 200 if ok, 503 if unhealthy.
      operationId: health
      responses:
        '200':
          description: Service healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
        '503':
          description: Service unhealthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: unhealthy

  /metrics:
    get:
      tags: [System]
      summary: Metrics
      description: Notification counts by status, success/failure rates, and RabbitMQ queue depths (when management API configured).
      operationId: metrics
      responses:
        '200':
          description: Metrics payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MetricsResponse'
        '500':
          description: Internal error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '503':
          description: Metrics provider not configured

components:
  parameters:
    NotificationId:
      name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid

  schemas:
    NotificationItem:
      type: object
      required: [recipient, channel, content]
      properties:
        recipient:
          type: string
          description: Phone, email, or device token
        channel:
          type: string
          enum: [sms, email, push]
        content:
          type: string
        priority:
          type: string
          enum: [high, normal, low]
          default: normal
        idempotency_key:
          type: string
          description: Optional unique key to prevent duplicates

    Notification:
      type: object
      properties:
        id:
          type: string
          format: uuid
        batch_id:
          type: string
          nullable: true
        recipient:
          type: string
        channel:
          type: string
          enum: [sms, email, push]
        content:
          type: string
        priority:
          type: string
          enum: [high, normal, low]
        status:
          type: string
          enum: [pending, queued, sent, failed, cancelled]
        idempotency_key:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        sent_at:
          type: string
          format: date-time
          nullable: true
        failure_reason:
          type: string
          nullable: true

    NotificationListResponse:
      type: object
      properties:
        notifications:
          type: array
          items:
            $ref: '#/components/schemas/Notification'
        total:
          type: integer

    BatchCreateResponse:
      type: object
      properties:
        batch_id:
          type: string
        notifications:
          type: array
          items:
            $ref: '#/components/schemas/Notification'

    Batch:
      type: object
      properties:
        id:
          type: string
        idempotency_key:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time

    BatchWithNotificationsResponse:
      type: object
      properties:
        batch:
          $ref: '#/components/schemas/Batch'
        notifications:
          type: array
          items:
            $ref: '#/components/schemas/Notification'

    CancelBatchResponse:
      type: object
      properties:
        cancelled:
          type: integer

    MetricsResponse:
      type: object
      properties:
        notifications:
          type: object
          properties:
            pending:
              type: integer
            queued:
              type: integer
            sent:
              type: integer
            failed:
              type: integer
            total:
              type: integer
        success_rate:
          type: number
          format: float
        failure_rate:
          type: number
          format: float
        queues:
          type: object
          additionalProperties:
            type: object
            properties:
              total:
                type: integer
              ready:
                type: integer
              unacked:
                type: integer

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          properties:
            code:
              type: string
              example: validation_error
            message:
              type: string
            details:
              type: object
        request_id:
          type: string
        timestamp:
          type: string
          format: date-time
